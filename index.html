
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>theory.so</title>
  <meta name="author" content="David E. Wheeler">

  
  <meta name="description" content="As part of my effort to improve Sqitch, I plan to add support for specifying
deployment targets via URIs. Inspired by Git remotes, targets will &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://theory.so">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="theory.so" type="application/atom+xml">
  

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43606412-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  <h2><a href="/"><img src="/images/logo.png" alt="≡" /></a></h2>
  <h1><a href="/">theory.so</a></h1>
</hgroup>

</header>
  <nav role="navigation">
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:theory.so" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
  <li><a href="http://pgxn.org/user/theory">PGXN</a></li>
  <li><a href="/about/">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
    
    









    <article >
      
  <header>
    <h1 class="entry-title">

<a href="/rfc/2013/11/26/toward-a-database-uri-standard/">Toward A Database URI Standard</a>

</h1>

    
      <p class="meta">
        








  


<time datetime="2013-11-26T20:14:00-08:00" pubdate data-updated="true">26 November 2013</time>
        
         &bull; <a rel="bookmark" href="/rfc/2013/11/26/toward-a-database-uri-standard/">§</a>
      </p>
    
  </header>



  <div class="entry-content"><p>As part of my effort to improve <a href="http://sqitch.org/" title="Sane database change management">Sqitch</a>, I plan to add support for <a href="https://github.com/theory/sqitch/issues/100" title="Issue #100: “Add target command to configure target databases”">specifying
deployment targets via URIs</a>. Inspired by <a href="http://git-scm.com/book/en/Git-Basics-Working-with-Remotes" title="Git Basics - Working with Remotes">Git remotes</a>, targets will greatly
simplify the specification of databases to update &mdash; especially when stored as
named targets in the configuration file.</p>

<p>Before implementing it, though, I started casting about for a standard
<a href="http://en.wikipedia.org/wiki/URI_scheme" title="Wikipedia: “URI Scheme”">URI Scheme</a> for database connections. Imagine my surprise<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> to find that
there is none! The closest thing to a standard is <a href="http://www.jguru.com/faq/view.jsp?EID=690" title="jGuru: “What is a database URL?”">JDBC URLs</a>. Formally, their
format is simply:</p>

<pre><code>jdbc:&lt;jdbc-specific-stuff&gt;
</code></pre>

<p>Turns out that JDBC URLs are <a href="https://groups.google.com/forum/#!topic/comp.lang.java.programmer/twkIYNaDS64" title="comp.lang.java.programmer: ”JDBC URLs ...not really URLs?“">barely URLs at all</a>. I mean, fine, according to
<a href="http://www.ietf.org/rfc/rfc2396.txt" title="Uniform Resource Identifiers (URI): Generic Syntax">RFC 2396</a> they start with the <code>jdbc:</code> scheme followed by whatever. According
to the <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/jdbc/getstart/connection.html#997649" title="Getting Started with the JDBC API: “JDBC URLs”">JDBC docs</a>, what comes after the scheme is defined as follows:</p>

<pre><code>jdbc:&lt;subprotocol&gt;:&lt;subname&gt;
</code></pre>

<p>The &ldquo;subprotocol&rdquo; is simply a driver name, while the the format of the &ldquo;subname
can vary, depending on the subprotocol, and it can have any internal syntax the
driver writer chooses, including a subsubname.&rdquo; In other words, it can be
anything at all. Not very satisfying, or particularly &ldquo;standard.&rdquo;<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup></p>

<p>In poking around the net, however, I found a fair number of database URI
formats defined by various projects:</p>

<ul>
<li><p><a href="http://www.postgresql.org/docs/9.3/static/libpq-connect.html#LIBPQ-CONNSTRING" title="PostgreSQL Documentation: “Connection Strings”">PostgreSQL libpq URIs</a>
<code>postgresql://[user[:password]@][netloc][:port][/dbname][?param1=value1&amp;...]</code></p></li>
<li><p><a href="http://docs.sqlalchemy.org/en/rel_0_9/core/engines.html#database-urls" title="SQLAlchemy Documentation: “Database Urls”">SQLAlchemy URLs</a>:
<code>dialect[+driver:]//[username[:password]@host[:port]/database</code></p></li>
<li><p><a href="http://docs.stackato.com/3.0/user/services/data-services.html#database-url" title="Stackato Documentation: “DATABASE_URL”">Stackato database URLs</a>:
<code>protocol://[username[:password]@host[:port]/database_name</code></p></li>
<li><p><a href="https://github.com/kennethreitz/dj-database-url" title="DJ-Database-URL on GitHub">Django database URLs</a>:
<code>ENGINE://[USER[:PASSWORD]@][HOST][:PORT]/DATABASE</code></p></li>
<li><p><a href="https://github.com/glenngillen/rails-database-url" title="rails-database-url on GitHub">Rails database URLs</a>:
<code>adapter://[userinfo@][hostname][:port]/database</code></p></li>
</ul>


<p>All very similar, right? Most database engines support all or a subset of these
connection parts in common:</p>

<ul>
<li>username</li>
<li>password</li>
<li>host address</li>
<li>port</li>
<li>database name</li>
<li>configuration parameters</li>
</ul>


<p>So why not define a standard database URI format with all those parts, and use
them where appropriate for each engine? It&rsquo;s all right there, just like
<a href="http://tools.ietf.org/html/rfc2616#page-19" title="RFC 2616: “http URL”">http URLs</a>.</p>

<h2>The Proposal</h2>

<p>Here&rsquo;s <a href="https://github.com/theory/uri-db" title="Database URI on GitHub">my proposal</a>. Formally, it&rsquo;s an opaque URI like JDBC. All database URIs
start with the scheme <code>db:</code>. But in this case, the opaque part is an embedded
URI that may be in one of two formats:</p>

<pre><code>engine://[username[:password]@]host[:port][/dbname][?params]
engine:[dbname][?params]
</code></pre>

<p>In other words, a pretty typical http- or mailto-style URI format. We embed it
in a <code>db:</code> URI in order to identify the URI as a database URI, and to have a
single reasonable scheme to register. Informally, it&rsquo;s simplest to think of a
database URI as a single URI starting with the combination of the scheme and
the engine, e.g., <code>db:mysql</code>.</p>

<p>Some notes on the formats:</p>

<ul>
<li><p>The Database URI <em>scheme</em> is <code>db</code>. Consequently, database URIs always start
with <code>db:</code>. This is the <a href="http://en.wikipedia.org/wiki/URI_scheme" title="Wikipedia: “URI Scheme”">URI scheme</a> that defines a database URI.</p></li>
<li><p>Next comes the database <em>engine</em>. This part is a string naming the type of
database engine for the database. It must always be followed by a colon, <code>:</code>.
There is no formal list of supported engines, though certain implementations
may specify engine-specific semantics, such as a default port.</p></li>
<li><p>The <em>authority</em> part is separated from the engine by a double slash, <code>//</code>,
and terminated by the next slash or end of the URI. It consists of an
optional user-information part, terminated by <code>@</code> (e.g.,
<code>username:password@</code>); a required host address (e.g., domain name or IP
address); and an optional port number, preceded by a colon, <code>:</code>.</p></li>
<li><p>The <em>path</em> part specifies the database name or path. For URIs that contain
an authority part, a path specifying a file name must be absolute. URIs
without an authority may use absolute or relative paths.</p></li>
<li><p>The optional <em>query</em> part, separated by a question mark, <code>?</code>, contains
<code>key=value</code> pairs separated by a semicolon, <code>;</code>, or ampersand, <code>&amp;</code>. These
parameters may be used to configure a database connection with parameters not
directly supported by the rest of the URI format.</p></li>
</ul>


<h3>Examples</h3>

<p>Here are some database URIs without an authority part, which is typical for
non-server engines such as <a href="http://sqlite.org/" title="SQLite Home Page">SQLite</a>, where the path part is a relative or
absolute file name:</p>

<ul>
<li><code>db:sqlite:</code></li>
<li><code>db:sqlite:foo.db</code></li>
<li><code>db:sqlite:../foo.db</code></li>
<li><code>db:sqlite:/var/db/foo.sqlite</code></li>
</ul>


<p>Other engines may use a database name rather than a file name:</p>

<ul>
<li><code>db:ingres:mydb</code></li>
<li><code>db:postgresql:template1</code></li>
</ul>


<p>When a URI includes an authority part, it must be preceded by a double slash:</p>

<ul>
<li><code>db:postgresql://example.com</code></li>
<li><code>db:mysql://root@localhost</code></li>
<li><code>db:pg://postgres:secr3t@example.net</code></li>
</ul>


<p>To add the database name, separate it from the authority by a single slash:</p>

<ul>
<li><code>db:postgresql://example.com/template1</code></li>
<li><code>db:mongodb://localhost:27017/myDatabase</code></li>
<li><code>db:oracle://scott:tiger@foo.com/scott</code></li>
</ul>


<p>Some databases, such as Firebird, take both a host name and a file path.
These paths must be absolute:</p>

<ul>
<li><code>db:firebird://localhost/tmp/test.gdb</code></li>
<li><code>db:firebird://localhost/C:/temp/test.gdb</code></li>
</ul>


<p>Any URI format may optionally have a query part containing key/value pairs:</p>

<ul>
<li><code>db:sqlite:foo.db?foreign_keys=ON;journal_mode=WAL</code></li>
<li><code>db:pg://localhost:5433/postgres?client_encoding=utf8;connect_timeout=10</code></li>
</ul>


<h2>Issues</h2>

<p>In discussing this proposal with various folks, I&rsquo;ve become aware of a few
challenges to standardization.</p>

<p>First, the requirement that the authority part must include a host address
prevents the specification of a URI with a username that can be used to connect
to a Unix socket. PostgreSQL and MySQL, among others provide authenticated
socket connections. Fortunately <a href="http://www.ietf.org/rfc/rfc2396.txt" title="Uniform Resource Identifiers (URI): Generic Syntax">RFC 2396</a> does not seem to require the host
name, and, as a precedent, neither do <a href="http://en.wikipedia.org/wiki/File_URI_scheme#Examples" title="Wikipedia: “File URI Scheme: Examples”">file URIs</a>. So I&rsquo;m thinking of allowing
something like this to connect to a PostgreSQL database</p>

<pre><code>db:pg://postgres:secr3t@/
</code></pre>

<p>In short, it makes sense to allow the user information without a host name.</p>

<p>The second issue is the disallowing of relative file names in the path part
following an authority part. The problem here is that most database engines
don&rsquo;t use paths for database names, so a leading slash makes no sense. For
example, in <code>db:pg:localhost/foo</code>, the PostgreSQL database name is <code>foo</code>, not
<code>/foo</code>. Yet in <code>db:firebird:localhost/foo</code>, the Firebird database name <em>is</em> a
path, <code>/foo</code>. So each engine implementation must know whether or not the path
part is a file name.</p>

<p>But some databases may in fact allow a path to be specified for a local
connection, and a name for a remote connection. <a href="https://metacpan.org/pod/DBD::Informix#INFORMIX-CONNECTION-SEMANTICS" title="MetaCPAN: “Informix Connection Semantics”">Informix</a> appears to support
such variation. So how is one to know whether the path is a file path or a
named database? The two variants cannot be distinguished.</p>

<p><a href="http://www.ietf.org/rfc/rfc2396.txt" title="Uniform Resource Identifiers (URI): Generic Syntax">RFC 2396</a> is quite explicit that the path part must be absolute when following
an authority part. It does allow an &ldquo;opaque part&rdquo; instead of an absolute path,
but in the absence of a slash, I&rsquo;m unable to figure out how to separate it from the host name.</p>

<p>The only solution I have so far found is to require a second slash for absolute
paths. Engines that use a simple name or relative path can have it just after
the slash, while an absolute path could use a second slash:</p>

<ul>
<li>Absolute: db:firebird://localhost//tmp/test.gdb</li>
<li>Relative: db:firebird://localhost/db/test.gdb</li>
<li>Name: db:postgresql://localhost/template1</li>
</ul>


<p>Naturally, <a href="http://www.ietf.org/rfc/rfc2396.txt" title="Uniform Resource Identifiers (URI): Generic Syntax">RFC 2396</a>&rsquo;s prohibition on the second slash gives me pause. I&rsquo;m not
sure how to resolve this issue. Suggestions appreciated!</p>

<h2>That&rsquo;s It</h2>

<p>The path issue aside, I feel like this is a pretty simple proposal, and could
have wide utility. I&rsquo;ve already knocked out a Perl reference implementation,
<a href="https://github.com/theory/uri-db/blob/master/lib/URI/db.pm" title="URI::db on GitHub">URI::db</a>. Given the wide availability of URI parsers in various programming
languages, I wouldn&rsquo;t expect it to be difficult to port, either.</p>

<p>The <a href="https://github.com/theory/uri-db/" title="uri-db on GitHub">uri-db project</a> is the canonical home for the proposal for now, so check
there for updates. And your feedback would be appreciated! What other issues
have I overlooked? What have I got wrong? Let me know!</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>As in not surprised at all. Though I was hoping!<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>DSNs for Perl&rsquo;s [DBI] aren&rsquo;t much better: <code>dbi:&lt;driver&gt;:&lt;driver-specific-stuff&gt;</code>.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>


    </article>
  
    
    









    <article >
      
  <header>
    <h1 class="entry-title">

<a href="/pg/2013/10/25/indexing-nested-hstore/">Indexing Nested hstore</a>

</h1>

    
      <p class="meta">
        








  


<time datetime="2013-10-25T14:36:00-07:00" pubdate data-updated="true">25 October 2013</time>
        
         &bull; <a rel="bookmark" href="/pg/2013/10/25/indexing-nested-hstore/">§</a>
      </p>
    
  </header>



  <div class="entry-content"><p>In my first <a href="/pg/2013/10/23/testing-nested-hstore/">Nested hstore</a> post yesterday, I ran a query against unindexed
hstore data, which required a table scan. But hstore is able to take
advantage of <a href="http://www.postgresql.org/docs/current/static/gin.html">GIN indexes</a>. So let&rsquo;s see what that looks like. Connecting to
the same database, I indexed the <code>review</code> column:</p>

<figure class='code'><figcaption><span>Indexing reviews</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">reviews</span><span class="o">=#</span> <span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_reviews_gin</span> <span class="k">ON</span> <span class="n">reviews</span> <span class="k">USING</span> <span class="n">GIN</span><span class="p">(</span><span class="n">review</span><span class="p">);</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">INDEX</span>
</span><span class='line'><span class="n">Time</span><span class="p">:</span> <span class="mi">360448</span><span class="p">.</span><span class="mi">426</span> <span class="n">ms</span>
</span><span class='line'><span class="n">reviews</span><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_database_size</span><span class="p">(</span><span class="n">current_database</span><span class="p">()));</span>
</span><span class='line'> <span class="n">pg_size_pretty</span>
</span><span class='line'><span class="c1">----------------</span>
</span><span class='line'> <span class="mi">421</span> <span class="n">MB</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well, that takes a while, and makes the database a lot bigger (it was 277 MB
unindexed). But is it worth it? Let&rsquo;s find out. Oleg and Teodor&rsquo;s patch adds
support for a nested hstore value on the right-hand-side of the <code>@&gt;</code>
operator. In practice, that means we can specify the full path to a nested
value as an hstore expression. In our case, to query only for Books, instead
of using this expression:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">WHERE</span> <span class="n">review</span> <span class="o">#&gt;</span> <span class="s1">&#39;{product,group}&#39;</span> <span class="o">=</span> <span class="s1">&#39;Book&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can use an hstore value with the entire path, including the value:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">WHERE</span> <span class="n">review</span> <span class="o">@&gt;</span> <span class="s1">&#39;{product =&gt; {group =&gt; Book}}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Awesome, right? Let&rsquo;s give it a try:</p>

<figure class='code'><figcaption><span>Query Book Reviews</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">reviews</span><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>    <span class="n">width_bucket</span><span class="p">(</span><span class="k">length</span><span class="p">(</span><span class="n">review</span> <span class="o">#&gt;</span> <span class="s1">&#39;{product,title}&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">title_length_bucket</span><span class="p">,</span>
</span><span class='line'>    <span class="n">round</span><span class="p">(</span><span class="k">avg</span><span class="p">(</span><span class="n">review</span> <span class="o">#^&gt;</span> <span class="s1">&#39;{review,rating}&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">review_average</span><span class="p">,</span>
</span><span class='line'>    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'>    <span class="n">reviews</span>
</span><span class='line'><span class="k">WHERE</span>
</span><span class='line'>    <span class="n">review</span> <span class="o">@&gt;</span> <span class="s1">&#39;{product =&gt; {group =&gt; Book}}&#39;</span>
</span><span class='line'><span class="k">GROUP</span> <span class="k">BY</span>
</span><span class='line'>    <span class="n">title_length_bucket</span>
</span><span class='line'><span class="k">ORDER</span> <span class="k">BY</span>
</span><span class='line'>    <span class="n">title_length_bucket</span><span class="p">;</span>
</span><span class='line'> <span class="n">title_length_bucket</span> <span class="o">|</span> <span class="n">review_average</span> <span class="o">|</span> <span class="k">count</span>
</span><span class='line'><span class="c1">---------------------+----------------+--------</span>
</span><span class='line'>                   <span class="mi">1</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">42</span> <span class="o">|</span>  <span class="mi">56299</span>
</span><span class='line'>                   <span class="mi">2</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">33</span> <span class="o">|</span> <span class="mi">170774</span>
</span><span class='line'>                   <span class="mi">3</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">45</span> <span class="o">|</span> <span class="mi">104778</span>
</span><span class='line'>                   <span class="mi">4</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">41</span> <span class="o">|</span>  <span class="mi">69719</span>
</span><span class='line'>                   <span class="mi">5</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">36</span> <span class="o">|</span>  <span class="mi">47110</span>
</span><span class='line'>                   <span class="mi">6</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">43</span> <span class="o">|</span>  <span class="mi">43070</span>
</span><span class='line'><span class="p">(</span><span class="mi">6</span> <span class="k">rows</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">Time</span><span class="p">:</span> <span class="mi">849</span><span class="p">.</span><span class="mi">681</span> <span class="n">ms</span>
</span></code></pre></td></tr></table></div></figure>


<p>That time looks better than yesterday&rsquo;s, but in truth I first ran this query
just before building the GIN index and got about the same result. Must be
that Mavericks is finished indexing my disk or something. At any rate, the
index is not buying us much here.</p>

<p>But hey, we&rsquo;re dealing with 1998 Amazon reviews, so querying against books
probably isn&rsquo;t very selective. I don&rsquo;t blame the planner for deciding that a
table scan is cheaper than an index scan. But what if we try a more selective
value, say &ldquo;DVD&rdquo;?</p>

<figure class='code'><figcaption><span>Query DVD Reivews</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">reviews</span><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>    <span class="n">width_bucket</span><span class="p">(</span><span class="k">length</span><span class="p">(</span><span class="n">review</span> <span class="o">#&gt;</span> <span class="s1">&#39;{product,title}&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">title_length_bucket</span><span class="p">,</span>
</span><span class='line'>    <span class="n">round</span><span class="p">(</span><span class="k">avg</span><span class="p">(</span><span class="n">review</span> <span class="o">#^&gt;</span> <span class="s1">&#39;{review,rating}&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">review_average</span><span class="p">,</span>
</span><span class='line'>    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'>    <span class="n">reviews</span>
</span><span class='line'><span class="k">WHERE</span>
</span><span class='line'>    <span class="n">review</span> <span class="o">@&gt;</span> <span class="s1">&#39;{product =&gt; {group =&gt; DVD}}&#39;</span>
</span><span class='line'><span class="k">GROUP</span> <span class="k">BY</span>
</span><span class='line'>    <span class="n">title_length_bucket</span>
</span><span class='line'><span class="k">ORDER</span> <span class="k">BY</span>
</span><span class='line'>    <span class="n">title_length_bucket</span><span class="p">;</span>
</span><span class='line'> <span class="n">title_length_bucket</span> <span class="o">|</span> <span class="n">review_average</span> <span class="o">|</span> <span class="k">count</span>
</span><span class='line'><span class="c1">---------------------+----------------+-------</span>
</span><span class='line'>                   <span class="mi">1</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">27</span> <span class="o">|</span>  <span class="mi">2646</span>
</span><span class='line'>                   <span class="mi">2</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">44</span> <span class="o">|</span>  <span class="mi">4180</span>
</span><span class='line'>                   <span class="mi">3</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">53</span> <span class="o">|</span>  <span class="mi">1996</span>
</span><span class='line'>                   <span class="mi">4</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">38</span> <span class="o">|</span>  <span class="mi">2294</span>
</span><span class='line'>                   <span class="mi">5</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">48</span> <span class="o">|</span>   <span class="mi">943</span>
</span><span class='line'>                   <span class="mi">6</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">42</span> <span class="o">|</span>   <span class="mi">738</span>
</span><span class='line'><span class="p">(</span><span class="mi">6</span> <span class="k">rows</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">Time</span><span class="p">:</span> <span class="mi">73</span><span class="p">.</span><span class="mi">913</span> <span class="n">ms</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wow! Under 100ms. That&rsquo;s more like it! <a href="http://en.wikipedia.org/wiki/Inverted_index">Inverted indexing</a> FTW!</p>
</div>


    </article>
  
    
    









    <article >
      
  <header>
    <h1 class="entry-title">

<a href="/pg/2013/10/23/testing-nested-hstore/">Testing Nested hstore</a>

</h1>

    
      <p class="meta">
        








  


<time datetime="2013-10-23T10:26:00-07:00" pubdate data-updated="true">23 October 2013</time>
        
         &bull; <a rel="bookmark" href="/pg/2013/10/23/testing-nested-hstore/">§</a>
      </p>
    
  </header>



  <div class="entry-content"><p>I&rsquo;ve been helping Oleg Bartunov and Teodor Sigaev with documentation for the
forthcoming <a href="http://www.sai.msu.su/~megera/postgres/talks/hstore-pgcon-2013.pdf">nested hstore</a> patch for <a href="http://www.posrgresql.org/">PostgreSQL</a>. It adds support for
arrays, numeric and boolean types, and of course arbitrarily nested data
structures. This gives it feature parity with <a href="http://json.org/">JSON</a>, but unlike the
<a href="http://www.postgresql.org/docs/current/static/datatype-json.html">JSON type</a>, its values are stored in a binary representation, which makes it
much more efficient to query. The support for <a href="http://www.postgresql.org/docs/current/static/gist.html">GiST</a> and <a href="http://www.postgresql.org/docs/current/static/gin.html">GIN</a> indexes to
speed up path searches doesn&rsquo;t hurt, either.</p>

<p>As part of the documentation, we wanted to include a short tutorial, something
to show off the schemaless flexibility of the new hstore. The <a href="http://citusdata.com/">CitusDB</a> guys
were kind enough to show off their <a href="https://github.com/citusdata/json_fdw">json_fdw</a> with some Amazon review data in
a <a href="http://citusdata.com/blog/65-run-sql-on-json-files-without-any-data-loads">blog post</a> a few months back; it even includes an interesting query against
the data. Let&rsquo;s see what we can do with it. First, load it:</p>

<figure class='code'><figcaption><span>Load Amazon Reviews as hstore</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; createdb reviews
</span><span class='line'>&gt; psql -d reviews -c <span class="s1">&#39;</span>
</span><span class='line'><span class="s1">    CREATE EXTENSION HSTORE;</span>
</span><span class='line'><span class="s1">    CREATE TABLE reviews(review hstore);</span>
</span><span class='line'><span class="s1">&#39;</span>
</span><span class='line'>CREATE TABLE
</span><span class='line'>&gt; gzcat customer_reviews_nested_1998.json.gz | sed -e <span class="s1">&#39;s/\\/\\\\/g&#39;</span> <span class="se">\</span>
</span><span class='line'> | sed -e <span class="s2">&quot;s/&#39;/&#39;&#39;/g&quot;</span> | sed -e <span class="s1">&#39;s/&quot;:/&quot; =&gt;/g&#39;</span> &gt; /tmp/hstore.copy
</span><span class='line'>&gt; <span class="nb">time </span>psql -d reviews -c <span class="s2">&quot;COPY reviews FROM &#39;/tmp/hstore.copy&#39;&quot;</span>
</span><span class='line'>COPY 589859
</span><span class='line'>       0.00s user 0.00s system 0% cpu 13.059 total
</span></code></pre></td></tr></table></div></figure>


<p>13 seconds to load 589,859 records from a file &ndash; a little over 45k records
per second. Not bad. Let&rsquo;s see what the storage looks like:</p>

<figure class='code'><figcaption><span>How Big is the hstore Data?</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; psql -d reviews -c <span class="s1">&#39;SELECT pg_size_pretty(pg_database_size(current_database()));&#39;</span>
</span><span class='line'> pg_size_pretty
</span><span class='line'>----------------
</span><span class='line'> 277 MB
</span></code></pre></td></tr></table></div></figure>


<p>The original, uncompressed data is 208 MB on disk, so roughly a third bigger
given the overhead of the database. Just for fun, let&rsquo;s compare it to JSON:</p>

<figure class='code'><figcaption><span>Load Amazon Reviews as JSON</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; createdb reviews_js
</span><span class='line'>&gt; psql -d reviews_js -c <span class="s1">&#39;CREATE TABLE reviews(review json);&#39;</span>
</span><span class='line'>CREATE TABLE
</span><span class='line'>&gt; gzcat customer_reviews_nested_1998.json.gz | sed -e <span class="s1">&#39;s/\\/\\\\/g&#39;</span> <span class="se">\</span>
</span><span class='line'> | sed -e <span class="s2">&quot;s/&#39;/&#39;&#39;/g&quot;</span> | &gt; /tmp/json.copy
</span><span class='line'>&gt; <span class="nb">time </span>psql -d reviews_js -c <span class="s2">&quot;COPY reviews FROM &#39;/tmp/json.copy&#39;&quot;</span>
</span><span class='line'>COPY 589859
</span><span class='line'>       0.00s user 0.00s system 0% cpu 7.434 total
</span><span class='line'>&gt; psql -d reviews_js -c <span class="s1">&#39;SELECT pg_size_pretty(pg_database_size(current_database()));&#39;</span>
</span><span class='line'> pg_size_pretty
</span><span class='line'>----------------
</span><span class='line'> 239 MB
</span></code></pre></td></tr></table></div></figure>


<p>Almost 80K records per second, faster, I&rsquo;m guessing, because the JSON type
doesn&rsquo;t convert the data to binary representation its way in. JSON currently
uses less overhead for storage, aw well; I wonder if that&rsquo;s the benefit of
<a href="http://www.postgresql.org/docs/current/static/storage-toast.html">TOAST storage</a>?</p>

<p>Let&rsquo;s try querying these guys. I adapted the query from the CitusDB <a href="http://citusdata.com/blog/65-run-sql-on-json-files-without-any-data-loads">blog
post</a> and ran it on my 2013 MacBook Air (1.7 GHz Intel Core i7) with iTunes
and a bunch of other apps running in the background [yeah, I&rsquo;m lazy]). Check
out those operators, by the way! Given a path, <code>#^&gt;</code> returns a numeric value:</p>

<figure class='code'><figcaption><span>Query the hstore-encoded reviews</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">reviews</span><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>    <span class="n">width_bucket</span><span class="p">(</span><span class="k">length</span><span class="p">(</span><span class="n">review</span> <span class="o">#&gt;</span> <span class="s1">&#39;{product,title}&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">title_length_bucket</span><span class="p">,</span>
</span><span class='line'>    <span class="n">round</span><span class="p">(</span><span class="k">avg</span><span class="p">(</span><span class="n">review</span> <span class="o">#^&gt;</span> <span class="s1">&#39;{review,rating}&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">review_average</span><span class="p">,</span>
</span><span class='line'>    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'>    <span class="n">reviews</span>
</span><span class='line'><span class="k">WHERE</span>
</span><span class='line'>    <span class="n">review</span> <span class="o">#&gt;</span> <span class="s1">&#39;{product,group}&#39;</span> <span class="o">=</span> <span class="s1">&#39;Book&#39;</span>
</span><span class='line'><span class="k">GROUP</span> <span class="k">BY</span>
</span><span class='line'>    <span class="n">title_length_bucket</span>
</span><span class='line'><span class="k">ORDER</span> <span class="k">BY</span>
</span><span class='line'>    <span class="n">title_length_bucket</span><span class="p">;</span>
</span><span class='line'> <span class="n">title_length_bucket</span> <span class="o">|</span> <span class="n">review_average</span> <span class="o">|</span> <span class="k">count</span>
</span><span class='line'><span class="c1">---------------------+----------------+--------</span>
</span><span class='line'>                   <span class="mi">1</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">42</span> <span class="o">|</span>  <span class="mi">56299</span>
</span><span class='line'>                   <span class="mi">2</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">33</span> <span class="o">|</span> <span class="mi">170774</span>
</span><span class='line'>                   <span class="mi">3</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">45</span> <span class="o">|</span> <span class="mi">104778</span>
</span><span class='line'>                   <span class="mi">4</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">41</span> <span class="o">|</span>  <span class="mi">69719</span>
</span><span class='line'>                   <span class="mi">5</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">36</span> <span class="o">|</span>  <span class="mi">47110</span>
</span><span class='line'>                   <span class="mi">6</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">43</span> <span class="o">|</span>  <span class="mi">43070</span>
</span><span class='line'><span class="p">(</span><span class="mi">6</span> <span class="k">rows</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">Time</span><span class="p">:</span> <span class="mi">2301</span><span class="p">.</span><span class="mi">620</span> <span class="n">ms</span>
</span></code></pre></td></tr></table></div></figure>


<p>The benefit of the native type is pretty apparent here. I ran this query
several times, and the time was always between 2.3 and 2.4 seconds. The Citus
<a href="https://github.com/citusdata/json_fdw">json_fdw</a> query took &ldquo;about 6 seconds on a 3.1 GHz CPU core.&rdquo; Let&rsquo;s see how
well the JSON type does (pity there is no operator to fetch a value as
numeric; we have to cast from text):</p>

<figure class='code'><figcaption><span>Query the JSON-encoded reviews</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">reviews_js</span><span class="o">=#</span> <span class="k">SELECT</span>
</span><span class='line'>    <span class="n">width_bucket</span><span class="p">(</span><span class="k">length</span><span class="p">(</span><span class="n">review</span> <span class="o">#&gt;&gt;</span> <span class="s1">&#39;{product,title}&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="n">title_length_bucket</span><span class="p">,</span>
</span><span class='line'>    <span class="n">round</span><span class="p">(</span><span class="k">avg</span><span class="p">((</span><span class="n">review</span> <span class="o">#&gt;&gt;</span> <span class="s1">&#39;{review,rating}&#39;</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">review_average</span><span class="p">,</span>
</span><span class='line'>    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'>    <span class="n">reviews</span>
</span><span class='line'><span class="k">WHERE</span>
</span><span class='line'>    <span class="n">review</span> <span class="o">#&gt;&gt;</span> <span class="s1">&#39;{product,group}&#39;</span> <span class="o">=</span> <span class="s1">&#39;Book&#39;</span>
</span><span class='line'><span class="k">GROUP</span> <span class="k">BY</span>
</span><span class='line'>    <span class="n">title_length_bucket</span>
</span><span class='line'><span class="k">ORDER</span> <span class="k">BY</span>
</span><span class='line'>    <span class="n">title_length_bucket</span><span class="p">;</span>
</span><span class='line'> <span class="n">title_length_bucket</span> <span class="o">|</span> <span class="n">review_average</span> <span class="o">|</span> <span class="k">count</span>
</span><span class='line'><span class="c1">---------------------+----------------+--------</span>
</span><span class='line'>                   <span class="mi">1</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">42</span> <span class="o">|</span>  <span class="mi">56299</span>
</span><span class='line'>                   <span class="mi">2</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">33</span> <span class="o">|</span> <span class="mi">170774</span>
</span><span class='line'>                   <span class="mi">3</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">45</span> <span class="o">|</span> <span class="mi">104778</span>
</span><span class='line'>                   <span class="mi">4</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">41</span> <span class="o">|</span>  <span class="mi">69719</span>
</span><span class='line'>                   <span class="mi">5</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">36</span> <span class="o">|</span>  <span class="mi">47110</span>
</span><span class='line'>                   <span class="mi">6</span> <span class="o">|</span>           <span class="mi">4</span><span class="p">.</span><span class="mi">43</span> <span class="o">|</span>  <span class="mi">43070</span>
</span><span class='line'><span class="p">(</span><span class="mi">6</span> <span class="k">rows</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">Time</span><span class="p">:</span> <span class="mi">5530</span><span class="p">.</span><span class="mi">120</span> <span class="n">ms</span>
</span></code></pre></td></tr></table></div></figure>


<p>A little faster than the <a href="https://github.com/citusdata/json_fdw">json_fdw</a> version, but comparable. But takes well
over twice as long as the hstore version, though. For queries, hstore is the
clear winner. Yes, you pay up-front for loading and storage, but the payoff at
query time is substantial. Ideally, of course, we would have the insert and
storage benefits of JSON <em>and</em> the query performance of hstore. There was talk
last spring at PGCon of using the same representation for JSON and hstore;
perhaps that can still come about.</p>

<p>Meanwhile, I expect to play with some other data sets over the next week;
watch this spot for more!</p>
</div>


    </article>
  
    
    



  







    <article data-linklog>
      
  <header>
    <h1 class="entry-title">

<a href="http://www.openscg.com/2013/09/the-power-of-enums/">The Power of Enums</a>
<span class='linklog-marker'>→</span>
</h1>

    
      <p class="meta">
        








  


<time datetime="2013-09-29T14:50:00-07:00" pubdate data-updated="true">29 September 2013</time>
        
         &bull; <a rel="bookmark" href="/pg/2013/09/29/the-power-of-enums/">§</a>
      </p>
    
  </header>



  <div class="entry-content"><p>Jim Mlodgenski on using <a href="http://www.postgresql.org/docs/9.3/static/datatype-enum.html">Enums</a> in place of references to small lookup tables:</p>

<blockquote><p>I saw something else I didn’t expect: […] There was a 8% increase
in performance. I was expecting the test with the enums to be close
to the baseline, but I wasn’t expecting it to be faster. Thinking
about it, it makes sense. Enums values are just numbers so we’re
effectively using surrogate keys under the covers, but the users would
still the the enum labels when they are looking at the data. It ended
up being a no brainer to use enums for these static tables. There was
a increase in performance while still maintaining the integrity of the
data.</p></blockquote>

<p>I&rsquo;ve been a big fan of Enums since Andrew and Tom Dunstan released a patch for
them during the PostgreSQL 8.2 era. Today they&rsquo;re a core feature, and as of
9.1, you can even modify their values! You&rsquo;re missing out if you&rsquo;re not using
them yet.</p>
</div>


    </article>
  
    
    



  







    <article data-linklog>
      
  <header>
    <h1 class="entry-title">

<a href="http://blog.cloudera.com/blog/2013/09/whats-next-for-impala-after-release-1-1/">Whither Impala Fault Tolerance?</a>
<span class='linklog-marker'>→</span>
</h1>

    
      <p class="meta">
        








  


<time datetime="2013-09-29T14:29:00-07:00" pubdate data-updated="true">29 September 2013</time>
        
         &bull; <a rel="bookmark" href="/impala/2013/09/29/whither-impala-fault-tolerance/">§</a>
      </p>
    
  </header>



  <div class="entry-content"><p>Justin Erickson on the <a href="http://blog.cloudera.com/">Cloudera Blog</a></p>

<blockquote><p>In December 2012, while Cloudera Impala was still in its beta phase, we
<a href="http://blog.cloudera.com/blog/2012/12/whats-next-for-cloudera-impala/">provided a roadmap</a>
for planned functionality in the production release. In the same spirit of
keeping Impala users, customers, and enthusiasts well informed, this post
provides an updated roadmap for upcoming releases later this year and in early
2014.</p></blockquote>

<p><a href="http://www.cloudera.com/content/cloudera/en/products/cdh/impala.html">Impala</a> is a pretty nice-looking SQLish query engine that runs on Hadoop. It
provides the same basic interface as <a href="http://hive.apache.org/">Hive</a>, but circumvents MapReduce to
access data directly from data nodes in parallel. But, in my opinion, to be
useful as a real-time query engine, it needs fault tolerance. From the
<a href="http://www.cloudera.com/content/cloudera-content/cloudera-docs/Impala/latest/Cloudera-Impala-Frequently-Asked-Questions/Cloudera-Impala-Frequently-Asked-Questions.html">Impala FAQ</a>, under the list of unsupported features:</p>

<blockquote><p>Fault tolerance for running queries (not currently). In the current release,
Impala aborts the query if any host on which the query is executing fails. In
the future, we will consider adding fault tolerance to Impala, so that a
running query would complete even in the presence of host failures.</p></blockquote>

<p>Sounds like an unfortunate issue. Since it&rsquo;s pretty typical for data nodes to
go down, this seems like an essential feature. Products like <a href="http://citusdata.com/docs/sql-on-hadoop" title="CitusDB SQL on Hadoop">CitusDB</a> offer
fault tolerance:</p>

<blockquote><p><strong>Does CitusDB recover from failures?</strong></p>

<p>Yes. The CitusDB master node intelligently re-routes the work on any failed
nodes to the remaining nodes in real-time. Since the underlying data are kept
in fixed-size blocks in HDFS, a failed node&rsquo;s work can evenly be distributed
among the remaining nodes in the cluster.</p></blockquote>

<p>That sound exactly right. I&rsquo;m excited about Citus, and if it adds solid
support for more data formats, such as <a href="http://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.0.0.2/ds_Hive/orcfile.html" title="ORC File Format">ORC</a> and <a href="http://parquet.io/" title="Parquet is a columnar storage format for Hadoop.">Parquet</a>, it may well be the
way to go. But Impala will be a nice alternative if it can get fault tolerance
figured out. I&rsquo;m disappointed it&rsquo;s not on the road map.</p>
</div>


    </article>
  
    
    









    <article >
      
  <header>
    <h1 class="entry-title">

<a href="/sqitch/2013/09/06/sqitch-templating/">Sqitch Templating</a>

</h1>

    
      <p class="meta">
        








  


<time datetime="2013-09-06T13:44:00-07:00" pubdate data-updated="true"> 6 September 2013</time>
        
         &bull; <a rel="bookmark" href="/sqitch/2013/09/06/sqitch-templating/">§</a>
      </p>
    
  </header>



  <div class="entry-content"><p>Last week saw the v.980 release of <a href="http://sqitch.org/" title="Sane database change management">Sqitch</a>, a database change management
system. The headline feature in this version is support for <a href="http://dev.mysql.com/" title="The world's most popular open source database">MySQL</a> 5.6.4 or
higher. Why 5.6.4 rather than 5.1 or even 5.5? Mainly because 5.6.4 finally
added support for fractional seconds in <code>DATETIME</code> columns (details in the
<a href="https://dev.mysql.com/doc/relnotes/mysql/5.6/en/news-5-6-4.html" title="Changes in MySQL 5.6.4 (2011-12-20, Milestone 7)">release notes</a>). This feature is essential for Sqitch, because changes often
execute within a second of each other, and the deploy time is included in the
log table&rsquo;s primary key.</p>

<p>With the requirement for fractional seconds satisfied by 5.6.4, there was
nothing to prevent usage of <a href="http://dev.mysql.com/doc/refman/5.5/en/condition-handling.html" title="MySQL 5.5 Reference Manual: Condition Handling"><code>SIGNAL</code></a>, added in 5.5, to
<a href="http://stackoverflow.com/a/17424570/79202" title="How do I get MySQL to throw a conditional runtime exception in SQL">mimic check constraints</a> in a trigger. This brings the Sqitch MySQL
implementation into line with what was already possible in the Postgres,
SQLite, and Oracle support. Check out the <a href="https://metacpan.org/module/sqitchtutorial-mysql" title="A tutorial introduction to Sqitch change management on MySQL">tutorial</a> and the accompanying
<a href="https://github.com/theory/sqitch-mysql-intro" title="Sqitch MySQL Intro Sample Repository">Git repository</a> to get started managing your MySQL databases with Sqitch.</p>

<p>The MySQL support might be the headliner, but the change in v0.980 I&rsquo;m most
excited about is improved template support. Sqitch executes templates to
create the default deploy, revert, and verify scripts, but up to now they have
not been easy to customize. With v0.980, you can create as many custom
templates as you like, and use them as appropriate.</p>

</div>
  <footer>
    <a rel="full-article" href="/sqitch/2013/09/06/sqitch-templating/">CONTINUE →</a>
  </footer>


    </article>
  
    
    



  







    <article data-linklog>
      
  <header>
    <h1 class="entry-title">

<a href="http://tapoueh.org/blog/2013/08/20-Window-Functions">Understanding Window Functions</a>
<span class='linklog-marker'>→</span>
</h1>

    
      <p class="meta">
        








  


<time datetime="2013-08-28T17:25:00-07:00" pubdate data-updated="true">28 August 2013</time>
        
         &bull; <a rel="bookmark" href="/pg/windows/2013/08/28/understanding-window-functions/">§</a>
      </p>
    
  </header>



  <div class="entry-content"><p>Dimitri Fontaine:</p>

<blockquote><p>There was SQL before
<a href="http://www.postgresql.org/docs/current/static/tutorial-window.html">window functions</a>
and SQL after <em>window functions:</em> that&rsquo;s how powerful this tool is. Being
that of a deal breaker unfortunately means that it can be quite hard to
grasp the feature. This article aims at making it crystal clear so that you
can begin using it today and are able to reason about it and recognize cases
where you want to be using <em>window functions.</em></p></blockquote>

<p>Great intro to a powerful feature.</p>
</div>


    </article>
  
    
    









    <article >
      
  <header>
    <h1 class="entry-title">

<a href="/sqitch/data/2013/08/28/data-deployment-with-sqitch/">Data Deployment with Sqitch</a>

</h1>

    
      <p class="meta">
        








  


<time datetime="2013-08-28T17:09:00-07:00" pubdate data-updated="true">28 August 2013</time>
        
         &bull; <a rel="bookmark" href="/sqitch/data/2013/08/28/data-deployment-with-sqitch/">§</a>
      </p>
    
  </header>



  <div class="entry-content"><p>I&rsquo;ve been thinking about data migrations. I love how well <a href="http://sqitch.org/">Sqitch</a> works for
<em>schema</em> changes, but so far have avoided <em>data</em> changes. Some data ought to
be managed by the deployment process, rather than by end-user applications.
Lists of countries, for example. Yet none of <a href="http://iovation.com/">our</a> Sqitch-managed databases
include <code>INSERT</code>s, <code>UPDATE</code>s, or <code>DELETE</code>s in deploy scripts. Why not? Two
reasons:</p>

<ol>
<li><p>These are mainly Postgres ports of existing Oracle databases. As such, I&rsquo;ve
written independent migration scripts that use <a href="http://pgxn.org/extension/oracle_fdw"><code>oracle_fdw</code></a> to copy data
from Oracle. It made no sense to commit hard-coded changes to the deploy
script, even for static data, as it was all to be copied from the old
production Oracle databases &mdash; often months after I wrote the migrations.</p></li>
<li><p>These projects include extensive <a href="http://pgtap.org/">pgTAP</a> unit tests that expect to run many
times against an empty database with no side effects. Having different data
in testing than in production increases the likelihood of unforeseen
behavioral variations. Better to expect <em>no</em> data in tests, freeing them to
focus on units of behavior without regard to preexisting data.</p></li>
</ol>


<p>Now that we have multiple Sqitch-deployed databases in production, the time
has come to address these issues.</p>

<h2>Deploy Hooks for External Sources</h2>

<p>I propose to resolve the one-time migration requirement with <a href="https://github.com/theory/sqitch/issues/96">deploy hooks</a>.
The idea is similar to <a href="http://git-scm.com/docs/githooks">Git hooks</a>: Before or after any <code>sqitch deploy</code>, one
or more hook scripts can run. The impetus was to ensure some higher level of
consistency after every <code>deploy</code>. For example, a post-deploy hook might grant
privileges on all tables in a database. Another might run <code>VACCUM; ANALZYE;</code>.</p>

<p>But we could also use it for one-time data migrations. An option to <code>deploy</code>
will disable them, which would be useful for development and test databases.
Once the migration has been run in production, we just delete the migration
hook scripts from the project. Sqitch won&rsquo;t record hook executions, so adding
or removing them will be no problem.</p>

<p>I like this approach, as Sqitch will automatically run migration scripts, but
hooks will not change the interface of Sqitch itself. And it&rsquo;s more generally
useful. Hell, I might want deploy hook script that sends an email notification
announcing a deployment (though that might require adding support for
<a href="https://github.com/theory/sqitch/issues/1">non-SQL scripts</a>). There are all kinds of things for which hooks will prove
useful.</p>

<h2>Changes for Static Data Maintenance</h2>

<p>For data that must be tied to the deployment process, there are two
complications that have prevetned me from simply managing them in normal
Sqitch changes:</p>

<ol>
<li><p>There might be side-effects to the deployment. For example, a foreign key
constraint to the <code>users</code> table, to identify the users who added rows to
the database. But in a new database, perhaps there are no users &mdash; and
Sqitch doesn&rsquo;t create them, the app does. Chicken, meet egg.</p></li>
<li><p>The initial data set might derived from some external source, such as
another database. Consequently, none of that data was defined in Sqitch
deploy scripts. This situation complicates future updates of the data. We
can add data via Sqitch in the future, but then we don&rsquo;t have the canonical
list of all rows that should exist in all such databases.</p></li>
</ol>


<p>However, I can think of no alternative that does not over-complicate Sqitch
itself. I considered adding another change-related script type, named
&ldquo;update&rdquo;, to complement the existing deploy, verify, and revert scripts. But
oftentimes a data change would not be tied to a schema change, so the
corresponding deploy script would be a no-op. Seems silly.</p>

<p>I also considered adding a completely separate command specifically for
deploying data changes. Yet these data migrations are exactly like schema
changes: Sqitch must execute them in the proper order relative to other
changes, record successful or failed deployment, and be able to revert them
when required. The only difference is what&rsquo;s defined in them: data
modification rather than definition.</p>

<p>Through several drafts of this post, I have come around to the idea that I
should change nothing in Sqitch with regard to data deployments. A better
solution than the above, I believe, is organizational.</p>

<h3>Data Deploy Best Practice</h3>

<p>Let the best practice for data deploys be this: they should be contained in
Sqitch changes, but such changes should contain <em>only</em> data modifications. No
change script should both define a table and insert its initial rows. Keep the
table and its data in separate changes &mdash; keep DML separate from DDL.</p>

<p>For our list of countries, we might have a change named &ldquo;countries&rdquo;, which
creates the <code>countries</code> table, and another, named &ldquo;country_data&rdquo;, which
inserts the appropriate data into that table. Where necessary and appropriate,
these changes may use conditional paths to bring the data up-to-date and in
sync across deployments.</p>

<p>Conditions must deal with side-effects, such as foreign key constraints. Where
possible, such side effects ought be removed from deployment-managed data. For
tracking the user or users who added data to a database, for example, one can
use the tools of the source code repository (<code>git log</code>, <code>git blame</code>) to assign
blame. Other side-effects may be more necessary, but to the extent possible,
deployed data should be independent.</p>

<p>Naturally, unit tests must expect static data to be present, and be updated
when that data changes. We are, after all, talking about infrequently-updated
data. Frequently-updated data should have separate interfaces provided by
applications to change the data. Otherwise, how static is it, really?</p>
</div>


    </article>
  
  <div class="pagination">
    
    <a href="/archives">Blog Archives</a>
    
  </div>
</div>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 – David E. Wheeler –
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> –
  <a href="/atom.xml" title="Subscribe to theory.com">Feed</a>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'theoryso';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
