
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Sqitch Templating - theory.so</title>
  <meta name="author" content="David E. Wheeler">

  
  <meta name="description" content="Last week saw the v.980 release of Sqitch, a database change management
system. The headline feature in this version is support for MySQL 5.6.4 or &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://theory.so/sqitch/2013/09/06/sqitch-templating">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="theory.so" type="application/atom+xml">
  

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43606412-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  <h2><a href="/"><img src="/images/logo.png" alt="≡" /></a></h2>
  <h1><a href="/">theory.so</a></h1>
</hgroup>

</header>
  <nav role="navigation">
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:theory.so" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
  <li><a href="http://pgxn.org/user/theory">PGXN</a></li>
  <li><a href="/about/">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>










<article class="hentry" role="article" >
  
  <header>
    <h1 class="entry-title">

Sqitch Templating

</h1>

    
      <p class="meta">
        








  


<time datetime="2013-09-06T13:44:00-07:00" pubdate data-updated="true"> 6 September 2013</time>
        
         &bull; <a rel="bookmark" href="/sqitch/2013/09/06/sqitch-templating/">§</a>
      </p>
    
  </header>



  <div class="entry-content"><p>Last week saw the v.980 release of <a href="http://sqitch.org/" title="Sane database change management">Sqitch</a>, a database change management
system. The headline feature in this version is support for <a href="http://dev.mysql.com/" title="The world's most popular open source database">MySQL</a> 5.6.4 or
higher. Why 5.6.4 rather than 5.1 or even 5.5? Mainly because 5.6.4 finally
added support for fractional seconds in <code>DATETIME</code> columns (details in the
<a href="https://dev.mysql.com/doc/relnotes/mysql/5.6/en/news-5-6-4.html" title="Changes in MySQL 5.6.4 (2011-12-20, Milestone 7)">release notes</a>). This feature is essential for Sqitch, because changes often
execute within a second of each other, and the deploy time is included in the
log table&rsquo;s primary key.</p>

<p>With the requirement for fractional seconds satisfied by 5.6.4, there was
nothing to prevent usage of <a href="http://dev.mysql.com/doc/refman/5.5/en/condition-handling.html" title="MySQL 5.5 Reference Manual: Condition Handling"><code>SIGNAL</code></a>, added in 5.5, to
<a href="http://stackoverflow.com/a/17424570/79202" title="How do I get MySQL to throw a conditional runtime exception in SQL">mimic check constraints</a> in a trigger. This brings the Sqitch MySQL
implementation into line with what was already possible in the Postgres,
SQLite, and Oracle support. Check out the <a href="https://metacpan.org/module/sqitchtutorial-mysql" title="A tutorial introduction to Sqitch change management on MySQL">tutorial</a> and the accompanying
<a href="https://github.com/theory/sqitch-mysql-intro" title="Sqitch MySQL Intro Sample Repository">Git repository</a> to get started managing your MySQL databases with Sqitch.</p>

<p>The MySQL support might be the headliner, but the change in v0.980 I&rsquo;m most
excited about is improved template support. Sqitch executes templates to
create the default deploy, revert, and verify scripts, but up to now they have
not been easy to customize. With v0.980, you can create as many custom
templates as you like, and use them as appropriate.</p>

<!-- more -->


<h2>A Custom Template</h2>

<p>Let&rsquo;s create a custom template for creating a table. The first step is to
create the template files. Custom templates can live in <code>`sqitch
&ndash;etc-path`/templates</code> or in <code>~/.sqitch/templates</code>. Let&rsquo;s use the
latter. Each template goes into a directory for the type of script, so we&rsquo;ll
create them:</p>

<figure class='code'><figcaption><span>Create template directories</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>mkdir -p ~/.sqitch/templates/deploy
</span><span class='line'>mkdir -p ~/.sqitch/templates/revert
</span><span class='line'>mkdir -p ~/.sqitch/templates/verify
</span></code></pre></td></tr></table></div></figure>


<p>Copy the default templates for your preferred database engine; here I copy the
Postgres templates:</p>

<figure class='code'><figcaption><span>Copy default templates</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">tmpldir</span><span class="o">=</span><span class="sb">`</span>sqitch --etc-path<span class="sb">`</span>/templates
</span><span class='line'>cp <span class="nv">$tmpldir</span>/deploy/pg.tmpl ~/.sqitch/templates/deploy/createtable.tmpl
</span><span class='line'>cp <span class="nv">$tmpldir</span>/revert/pg.tmpl ~/.sqitch/templates/revert/createtable.tmpl
</span><span class='line'>cp <span class="nv">$tmpldir</span>/verify/pg.tmpl ~/.sqitch/templates/verify/createtable.tmpl
</span><span class='line'>chmod -R +w ~/.sqitch/templates
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s what the default deploy template looks like:</p>

<figure class='code'><figcaption><span>Default deploy template</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- Deploy [% change %]</span>
</span><span class='line'><span class="p">[</span><span class="o">%</span> <span class="n">FOREACH</span> <span class="n">item</span> <span class="k">IN</span> <span class="n">requires</span> <span class="o">-%</span><span class="p">]</span>
</span><span class='line'><span class="c1">-- requires: [% item %]</span>
</span><span class='line'><span class="p">[</span><span class="o">%</span> <span class="k">END</span> <span class="o">-%</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="o">%</span> <span class="n">FOREACH</span> <span class="n">item</span> <span class="k">IN</span> <span class="n">conflicts</span> <span class="o">-%</span><span class="p">]</span>
</span><span class='line'><span class="c1">-- conflicts: [% item %]</span>
</span><span class='line'><span class="p">[</span><span class="o">%</span> <span class="k">END</span> <span class="o">-%</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">BEGIN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- XXX Add DDLs here.</span>
</span><span class='line'>
</span><span class='line'><span class="k">COMMIT</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code before the <code>BEGIN</code> names the template and lists dependencies, which
is reasonably useful, so we&rsquo;ll leave it as-is. We&rsquo;ll focus on replacing that
comment, <code>-- XXX Add DDLs here.</code>, with the template for a <code>CREATE TABLE</code>
statement. Start simple: just use the change name for the table name. In
<code>~/.sqitch/templates/deploy/createtable.tmpl</code>, replace the comment with these
lines:</p>

<figure class='code'><figcaption><span>Add CREATE TABLE statement to deploy template</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="p">[</span><span class="o">%</span> <span class="n">change</span> <span class="o">%</span><span class="p">]</span> <span class="p">(</span>
</span><span class='line'>    <span class="c1">-- Add columns here.</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the revert template, <code>~/.sqitch/templates/deploy/createtable.tmpl</code>, replace
the comment with a <code>DROP TABLE</code> statement:</p>

<figure class='code'><figcaption><span>Add DROP TABLE statement to revert template</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">DROP</span> <span class="k">TABLE</span> <span class="p">[</span><span class="o">%</span> <span class="n">change</span> <span class="o">%</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>And finally, in the verify template,
<code>~/.sqitch/templates/verify/createtable.tmpl</code>, replace the comment with a
simple <code>SELECT</code> statement, which is just enough to verify the creation of a
table:</p>

<figure class='code'><figcaption><span>Add SELECT statement to verify template</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="p">[</span><span class="o">%</span> <span class="n">change</span> <span class="o">%</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Great, we&rsquo;ve created a set of simple customized templates for adding a
<code>CREATE TABLE</code> change to a Sqitch project. To use them, just pass the
<code>--template</code> option to <a href="http://metacpan.org/module/sqitch-add" title="Add a database change to the Sqitch plan"><code>sqitch add</code></a>, like so:</p>

<figure class='code'><figcaption><span>Use the createtable template</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>&gt; sqitch add widgets --template createtable -n <span class="s1">&#39;Add widgets table.&#39;</span>
</span><span class='line'>Created deploy/widgets.sql
</span><span class='line'>Created revert/widgets.sql
</span><span class='line'>Created verify/widgets.sql
</span><span class='line'>Added <span class="s2">&quot;widgets&quot;</span> to sqitch.plan
</span></code></pre></td></tr></table></div></figure>


<p>Now have a look at <code>deploy/widgets.sql</code>:</p>

<figure class='code'><figcaption><span>Widgets Deploy Script</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- Deploy widgets</span>
</span><span class='line'>
</span><span class='line'><span class="k">BEGIN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">widgets</span> <span class="p">(</span>
</span><span class='line'>    <span class="c1">-- Add columns here.</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">COMMIT</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Cool! The revert template should also have done its job. Here&rsquo;s
<code>revert/widgets.sql</code>:</p>

<figure class='code'><figcaption><span>Widgets Revert Script</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- Revert widgets</span>
</span><span class='line'>
</span><span class='line'><span class="k">BEGIN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">widgets</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">COMMIT</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the verify script, <code>verify/widgets.sql</code>:</p>

<figure class='code'><figcaption><span>Widgets Verify Script</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- Verify widgets</span>
</span><span class='line'>
</span><span class='line'><span class="k">BEGIN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">widgets</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">ROLLBACK</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Custom Table Name</h2>

<p>What if you want to name the change one thing and the table it creates
something else? What if you want to schema-qualify the table? Easy! Sqitch&rsquo;s
dead simple default <a href="https://metacpan.org/module/sqitch-add#Syntax" title="Sqitch Template Syntax">templating language</a>, <a href="https://metacpan.org/module/Template::Tiny">Template::Tiny</a>, features <code>if</code>
statements. Try using them with custom variables for the schema and table
names:</p>

<figure class='code'><figcaption><span>Deploy table with schema and table</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SET</span> <span class="n">search_path</span> <span class="k">TO</span> <span class="p">[</span><span class="o">%</span> <span class="n">IF</span> <span class="k">schema</span> <span class="p">][</span><span class="o">%</span> <span class="k">schema</span> <span class="o">%</span><span class="p">],[</span><span class="o">%</span> <span class="k">END</span> <span class="o">%</span><span class="p">]</span><span class="k">public</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="p">[</span><span class="o">%</span> <span class="n">IF</span> <span class="k">table</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="k">table</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="k">ELSE</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="n">change</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="k">END</span> <span class="o">%</span><span class="p">]</span> <span class="p">(</span>
</span><span class='line'>    <span class="c1">-- Add columns here.</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>If the <code>schema</code> variable is set, the <code>search_path</code>, which determines where
objects will go, gets set to <code>$schema,public</code>. If <code>schema</code> is not set, the
path is simply <code>public</code>, which is the default schema in Postgres.</p>

<p>We take a similar tack with the <code>CREATE TABLE</code> statement: If the <code>table</code>
variable is set, it&rsquo;s used as the name of the table. Otherwise, we use the
change name, as before.</p>

<p>The revert script needs the same treatment:</p>

<figure class='code'><figcaption><span>Revert table with schema and table</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SET</span> <span class="n">search_path</span> <span class="k">TO</span> <span class="p">[</span><span class="o">%</span> <span class="n">IF</span> <span class="k">schema</span> <span class="p">][</span><span class="o">%</span> <span class="k">schema</span> <span class="o">%</span><span class="p">],[</span><span class="o">%</span> <span class="k">END</span> <span class="o">%</span><span class="p">]</span><span class="k">public</span><span class="p">;</span>
</span><span class='line'><span class="k">DROP</span> <span class="k">TABLE</span> <span class="p">[</span><span class="o">%</span> <span class="n">IF</span> <span class="k">table</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="k">table</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="k">ELSE</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="n">change</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="k">END</span> <span class="o">%</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>As does the verify script:</p>

<figure class='code'><figcaption><span>Verify table with schema and table</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SET</span> <span class="n">search_path</span> <span class="k">TO</span> <span class="p">[</span><span class="o">%</span> <span class="n">IF</span> <span class="k">schema</span> <span class="p">][</span><span class="o">%</span> <span class="k">schema</span> <span class="o">%</span><span class="p">],[</span><span class="o">%</span> <span class="k">END</span> <span class="o">%</span><span class="p">]</span><span class="k">public</span><span class="p">;</span>
</span><span class='line'><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="p">[</span><span class="o">%</span> <span class="n">IF</span> <span class="k">table</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="k">table</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="k">ELSE</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="n">change</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="k">END</span> <span class="o">%</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Take it for a spin:</p>

<figure class='code'><figcaption><span>Add table to schema</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>&gt; sqitch add corp_widgets --template createtable <span class="se">\</span>
</span><span class='line'>  --set <span class="nv">schema</span><span class="o">=</span>corp --set <span class="nv">table</span><span class="o">=</span>widgets <span class="se">\</span>
</span><span class='line'>  -n <span class="s1">&#39;Add corp.widgets table.&#39;</span>
</span><span class='line'>Created deploy/corp_widgets.sql
</span><span class='line'>Created revert/corp_widgets.sql
</span><span class='line'>Created verify/corp_widgets.sql
</span><span class='line'>Added <span class="s2">&quot;corp_widgets&quot;</span> to sqitch.plan
</span></code></pre></td></tr></table></div></figure>


<p>The resulting deploy script will create <code>corp.widgets</code>:</p>

<figure class='code'><figcaption><span>Deploy table to schema</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- Deploy corp_widgets</span>
</span><span class='line'>
</span><span class='line'><span class="k">BEGIN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">SET</span> <span class="n">search_path</span> <span class="k">TO</span> <span class="n">corp</span><span class="p">,</span><span class="k">public</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">widgets</span> <span class="p">(</span>
</span><span class='line'>    <span class="c1">-- Add columns here.</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">COMMIT</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Cool, right? The revert and verify scripts of course yield similar results.
Omitting the <code>--set</code> option, the template falls back on the change name:</p>

<figure class='code'><figcaption><span>Deploy a table to public</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- Deploy widgets</span>
</span><span class='line'>
</span><span class='line'><span class="k">BEGIN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">SET</span> <span class="n">search_path</span> <span class="k">TO</span> <span class="k">public</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">widgets</span> <span class="p">(</span>
</span><span class='line'>    <span class="c1">-- Add columns here.</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">COMMIT</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Add Columns</h2>

<p>Template variables may contain array values. The default templates takes
advantage of this feature to list dependencies in SQL comments. It works great
for custom variables, too. For the purposes of our <code>CREATE TABLE</code> template,
let&rsquo;s add columns. Replace the <code>-- Add columns here</code> comment in the deploy
simple with these three lines:</p>

<figure class='code'><figcaption><span>Deploy script with columns</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="p">[</span><span class="o">%</span> <span class="n">FOREACH</span> <span class="n">col</span> <span class="k">IN</span> <span class="k">column</span> <span class="o">-%</span><span class="p">]</span>
</span><span class='line'>    <span class="p">[</span><span class="o">%</span> <span class="n">col</span> <span class="o">%</span><span class="p">]</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'><span class="p">[</span><span class="o">%</span> <span class="k">END</span> <span class="o">-%</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can similarly improve the verify script: change its <code>SELECT</code> statement to:</p>

<figure class='code'><figcaption><span>Verify script with columns</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="p">[</span><span class="o">%</span> <span class="n">FOREACH</span> <span class="n">col</span> <span class="k">IN</span> <span class="k">column</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="n">col</span> <span class="o">%</span><span class="p">],</span> <span class="p">[</span><span class="o">%</span> <span class="k">END</span> <span class="o">%</span><span class="p">]</span>
</span><span class='line'>  <span class="k">FROM</span> <span class="p">[</span><span class="o">%</span> <span class="n">IF</span> <span class="k">table</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="k">table</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="k">ELSE</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="n">change</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="k">END</span> <span class="o">%</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just pass multiple <code>--set</code> (or <code>-s</code>) options to <code>sqitch add</code> to add as many
columns as you like:</p>

<figure class='code'><figcaption><span>Add table with columns</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>&gt; sqitch add corp_widgets --template createtable <span class="se">\</span>
</span><span class='line'>  -s <span class="nv">schema</span><span class="o">=</span>corp -s <span class="nv">table</span><span class="o">=</span>widgets <span class="se">\</span>
</span><span class='line'>  -s <span class="nv">column</span><span class="o">=</span>id -s <span class="nv">column</span><span class="o">=</span>name -s <span class="nv">column</span><span class="o">=</span>quantity <span class="se">\</span>
</span><span class='line'>  -n <span class="s1">&#39;Add corp.widgets table.&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Behold the resulting deploy script!</p>

<figure class='code'><figcaption><span>Deploy table with columns</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- Deploy corp_widgets</span>
</span><span class='line'>
</span><span class='line'><span class="k">BEGIN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">SET</span> <span class="n">search_path</span> <span class="k">TO</span> <span class="n">corp</span><span class="p">,</span><span class="k">public</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">widgets</span> <span class="p">(</span>
</span><span class='line'>    <span class="n">id</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'>    <span class="n">name</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'>    <span class="n">quantity</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">COMMIT</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>You still have to edit the resulting file, of course. Maybe <code>NULL</code>s should be
allowed in the <code>name</code> column. And I suspect that <code>quantity</code> ought be an
integer. There&rsquo;s that pesky trailing comma to remove, too. The verify script
suffers the same deficiency:</p>

<figure class='code'><figcaption><span>Verify each column</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- Verify corp_widgets</span>
</span><span class='line'>
</span><span class='line'><span class="k">BEGIN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">SET</span> <span class="n">search_path</span> <span class="k">TO</span> <span class="n">corp</span><span class="p">,</span><span class="k">public</span><span class="p">;</span>
</span><span class='line'><span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span>
</span><span class='line'>  <span class="k">FROM</span> <span class="n">widgets</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">ROLLBACK</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Still, these templates remove much of the grudge work of adding <code>CREATE TABLE</code>
changes, giving you the scaffolding on which to build the objects you need.</p>

<h2>Upgraded Templates</h2>

<p>We call Sqitch&rsquo;s <a href="https://metacpan.org/module/sqitch-add#Syntax" title="Sqitch Template Syntax">templating language</a> &ldquo;default&rdquo; because it can be replaced
with a more capable one. Simply install <a href="http://tt2.org/">Template Toolkit</a> to transparently
upgrade your Sqitch templates. Template Toolkit&rsquo;s comprehensive feature set
covers just about any functionality you could want out of a templating system.
It&rsquo;s big and complex, but relatively straight-forward to install: just run
<code>cpan Template</code>, <code>cpanm Tempate</code>, <code>yum install perl-Template-Toolkit</code>, or the
like and you&rsquo;ll be in business.</p>

<p>We can resolve the trailing comma issue thanks to Template Toolkit&rsquo;s <code>loop</code>
variable, which is implicitly created in the <code>FOREACH</code> loop. Simply replace
the comma in the template with the expression <code>[% loop.last ? '' : ',' %]</code>:</p>

<figure class='code'><figcaption><span>Use the loop variable</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="p">[</span><span class="o">%</span> <span class="n">FOREACH</span> <span class="n">col</span> <span class="k">IN</span> <span class="k">column</span> <span class="o">-%</span><span class="p">]</span>
</span><span class='line'>    <span class="p">[</span><span class="o">%</span> <span class="n">col</span> <span class="o">%</span><span class="p">]</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">[</span><span class="o">%</span> <span class="n">loop</span><span class="p">.</span><span class="k">last</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="p">:</span> <span class="s1">&#39;,&#39;</span> <span class="o">%</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="o">%</span> <span class="k">END</span> <span class="o">-%</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the comma will be omitted for the last iteration of the loop. The fix for
the verify script is even simpler: use <code>join()</code> <a href="http://tt2.org/docs/manual/VMethods.html" title="Template Toolkit Docs: Virtual Methods">VMethod</a> instead of a
<code>FOREACH</code> loop to emit all the columns in a single expression:</p>

<figure class='code'><figcaption><span>Join verify columns</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="p">[</span><span class="o">%</span> <span class="k">column</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="o">%</span><span class="p">]</span>
</span><span class='line'>  <span class="k">FROM</span> <span class="p">[</span><span class="o">%</span> <span class="n">IF</span> <span class="k">table</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="k">table</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="k">ELSE</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="n">change</span> <span class="o">%</span><span class="p">][</span><span class="o">%</span> <span class="k">END</span> <span class="o">%</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Really simplifies things, doesn&rsquo;t it?</p>

<p>Better still, going back to the deploy template, we can add data types for
each column. Try this on for size:</p>

<figure class='code'><figcaption><span>Deploy with typed columns</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>% FOREACH col IN column -%<span class="o">]</span>
</span><span class='line'>    <span class="o">[</span>% col %<span class="o">]</span> <span class="o">[</span>% type.item<span class="o">(</span> loop.index <span class="o">)</span> or <span class="s1">&#39;TEXT&#39;</span> %<span class="o">]</span> NOT NULL<span class="o">[</span>% loop.last ? <span class="s1">&#39;&#39;</span> : <span class="s1">&#39;,&#39;</span> %<span class="o">]</span>
</span><span class='line'><span class="o">[</span>% END -%<span class="o">]</span>
</span><span class='line'><span class="o">)</span>;
</span></code></pre></td></tr></table></div></figure>


<p>As we iterate over the list of columns, simply pass <code>loop.index</code> to the
<code>item()</code> <a href="http://tt2.org/docs/manual/VMethods.html" title="Template Toolkit Docs: Virtual Methods">VMethod</a> on the <code>type</code> variable to get the corresponding type.
Then specify a type for each column when you create the change:</p>

<figure class='code'><figcaption><span>Create table with typed columns</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>&gt; sqitch add corp_widgets --template createtable <span class="se">\</span>
</span><span class='line'>  -s <span class="nv">schema</span><span class="o">=</span>corp -s <span class="nv">table</span><span class="o">=</span>widgets <span class="se">\</span>
</span><span class='line'>  -s <span class="nv">column</span><span class="o">=</span>id -s <span class="nb">type</span><span class="o">=</span>SERIAL <span class="se">\</span>
</span><span class='line'>  -s <span class="nv">column</span><span class="o">=</span>name -s <span class="nb">type</span><span class="o">=</span>TEXT <span class="se">\</span>
</span><span class='line'>  -s <span class="nv">column</span><span class="o">=</span>quantity -s <span class="nb">type</span><span class="o">=</span>INTEGER <span class="se">\</span>
</span><span class='line'>  -n <span class="s1">&#39;Add corp.widgets table.&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This yields a much more comprehensive deploy script:</p>

<figure class='code'><figcaption><span>Deploy table with typed columns</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="c1">-- Deploy corp_widgets</span>
</span><span class='line'>
</span><span class='line'><span class="k">BEGIN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">SET</span> <span class="n">search_path</span> <span class="k">TO</span> <span class="n">corp</span><span class="p">,</span><span class="k">public</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">widgets</span> <span class="p">(</span>
</span><span class='line'>    <span class="n">id</span> <span class="nb">SERIAL</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'>    <span class="n">name</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'>    <span class="n">quantity</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">COMMIT</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Go Crazy</h2>

<p>The basics for creating task-specific change templates are baked into Sqitch,
and a transparent upgrade to advanced templating is a simple install away. I
can imagine lots of uses for task-specific changes, including:</p>

<ul>
<li>Adding schemas, users, procedures, and views</li>
<li>Modifying tables to add columns, constraints and indexes</li>
<li>Inserting or Updating data</li>
</ul>


<p>Maybe folks will even start sharing templates! You should subscribe to the
<a href="https://groups.google.com/forum/#!forum/sqitch-users">mail list</a> to find out. See you there?</p>
</div>


  <footer>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://theory.so/sqitch/2013/09/06/sqitch-templating/" data-via="theory" data-counturl="http://theory.so/sqitch/2013/09/06/sqitch-templating/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="false" data-layout="button_count" data-width="200" data-show-faces="false"></div>
  
  
  <span class="adn-post"><a href="https://alpha.app.net/intent/post/?url=/sqitch/2013/09/06/sqitch-templating/&text=theory.so: “Sqitch Templating”" class="adn-button" target="_blank" data-type="share" data-width="132" data-height="20" data-text="theory.so: “Sqitch Templating”" data-url="/sqitch/2013/09/06/sqitch-templating/" >Share on App.net</a></span>
  <script>(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//d2zh9g63fcvyrq.cloudfront.net/adn.js";fjs.parentNode.insertBefore(js,fjs);}}(document, "script", "adn-button-js"));</script>
  
</div>

    
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (David E. Wheeler)" rel="author">David E. Wheeler</a></span></span>

      








  


<time datetime="2013-09-06T13:44:00-07:00" pubdate data-updated="true"> 6 September 2013</time>
      

<span class="categories">
  
    <a class='category' href='/categories/sqitch/'>sqitch</a>
  
</span>


    </p>
          <div class="follow_buttons_byline">

  <a href="http://twitter.com/theory" class="twitter-follow-button" data-show-count="true">Follow @theory</a>


   <a href="https://alpha.app.net/intent/follow/?user_id=%40theory" class="adn-button" target="_blank" data-type="follow" data-width="277" data-height="20" data-user-id="@theory" data-show-count="1" data-show-username="1">Follow me on App.net</a>
<script src="//d2zh9g63fcvyrq.cloudfront.net/adn.js"></script>

      </div>

    <p class="meta">
      
        <a class="basic-alignment left" href="/pg/windows/2013/08/28/understanding-window-functions/" title="Previous Post: Understanding Window Functions">&laquo; Understanding Window Functions</a>
      
      
        <a class="basic-alignment right" href="/impala/2013/09/29/whither-impala-fault-tolerance/" title="next Post: Whither Impala Fault Tolerance?">Whither Impala Fault Tolerance? &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 – David E. Wheeler –
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> –
  <a href="/atom.xml" title="Subscribe to theory.com">Feed</a>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'theoryso';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://theory.so/sqitch/2013/09/06/sqitch-templating/';
        var disqus_url = 'http://theory.so/sqitch/2013/09/06/sqitch-templating/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
